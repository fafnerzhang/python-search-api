name: Performance Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1' # Run weekly on Monday at 2 AM

jobs:
  performance:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python 3.11
      run: uv python install 3.11

    - name: Install dependencies
      run: |
        make install

    - name: Start application in development mode
      run: |
        make dev &
        APP_PID=$!
        echo "APP_PID=$APP_PID" >> $GITHUB_ENV
        sleep 10

    - name: Wait for application to be ready
      run: |
        timeout 30 bash -c 'until curl -f http://localhost:9410/health; do sleep 1; done'

    - name: Install performance testing tools
      run: |
        pip install locust

    - name: Run basic performance tests
      run: |
        # Simple load test with curl
        echo "Running basic load test..."
        for i in {1..10}; do
          curl -f http://localhost:9410/health || exit 1
        done
        
        # Test search endpoint
        curl -X POST "http://localhost:9410/search" \
          -H "Content-Type: application/json" \
          -d '{"query": "test", "max_results": 5}' || exit 1

    - name: Memory and CPU usage check
      run: |
        # Check if the application is running efficiently
        ps -p $APP_PID -o pid,ppid,cmd,%mem,%cpu

    - name: Stop application
      if: always()
      run: |
        if [ ! -z "$APP_PID" ]; then
          kill $APP_PID || true
        fi
